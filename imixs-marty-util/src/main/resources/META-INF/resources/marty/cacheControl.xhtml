<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:cc="http://java.sun.com/jsf/composite">

<cc:interface>
	<cc:attribute name="redirect"></cc:attribute>
	<cc:attribute name="clear" default="false" type="java.lang.Boolean"></cc:attribute>
</cc:interface>

<cc:implementation>

	<c:if test="#{cc.attrs.clear}">
		<!-- Clear browser cache -->
		<f:event type="preRenderView"
			listener="#{browserCacheController.clearCache}" />
	</c:if>

	
	<script type="text/javascript">
		/*<![CDATA[*/
		           
		var currentBrowserWindowID=#{browserCacheController.browserWindowID};
		           
		// update _browserWindowID for next post		           
		if(window.onpageshow || window.onpageshow === null){
			window.addEventListener('pageshow', function() {
				validateBrowserWindowID(currentBrowserWindowID);
			}, false);
		} else {
			// use jquery document ready
			$(document).ready(function() {
				validateBrowserWindowID(currentBrowserWindowID);
			}); 
		}
		
		
		/* 
		 * Update browserWindowID and test if SesseionStorrage for lastbrowserWindowID
		 * to redirect if page comes from browser cache
		 */
		function validateBrowserWindowID(browserWindowID) {
			// set _browserWindowID for the next post request
			$("[id$=\\:browserWindowID]").val(browserWindowID);
			
			// try to redirect if the browserWindowID is deprecated.....
			if (!('localStorage' in window && window['localStorage'] !== null))
				return true; // old browsers are not supported for that feature

			// test if a redirect was defined.....
			var newLocation="#{cc.attrs.redirect}";
			if (newLocation!=null && newLocation.length>0) {
				// read lastBrowserWindowID from the sessionStorrage
				var lastBrowserWindowID=sessionStorage.getItem("org.imixs.lastBrowserWindowID");
				if (lastBrowserWindowID!=null && browserWindowID<=lastBrowserWindowID) {
					// ID is deprecated - redirect!
					document.location="#{cc.attrs.redirect}";
				} else {
					// update lastBrowserWindowID...
					sessionStorage.setItem("org.imixs.lastBrowserWindowID", browserWindowID);
				}
			}
		}
		
		
		
		/*]]>*/
	</script>
	<!-- hidden field to store the _BrowserWindowID -->
	<h:inputText id="browserWindowID" value="#{workflowController.workitem.item['_browserWindowID']}" />

</cc:implementation>


</html>


